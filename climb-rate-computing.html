<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Smartphone variometer - Flight Computing</title><meta name="description" content="In this article we're going to explore the problems of computing vertical speed from pressure data obtained from meteorological or first-fix gps purpose pressure sensors, some smartphones have built-in (Bosch Sensortec BMP180, BMP280). To obtain the climb or descent rate we must take the derivative of the pressure signal with&hellip;"><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://flightcomp.github.io/website/climb-rate-computing.html"><link rel="alternate" type="application/atom+xml" href="https://flightcomp.github.io/website/feed.xml"><link rel="alternate" type="application/json" href="https://flightcomp.github.io/website/feed.json"><meta property="og:title" content="Smartphone variometer"><meta property="og:image" content="https://flightcomp.github.io/website/media/posts/2/kalman2.png"><meta property="og:site_name" content="Flight Computing"><meta property="og:description" content="In this article we're going to explore the problems of computing vertical speed from pressure data obtained from meteorological or first-fix gps purpose pressure sensors, some smartphones have built-in (Bosch Sensortec BMP180, BMP280). To obtain the climb or descent rate we must take the derivative of the pressure signal with&hellip;"><meta property="og:url" content="https://flightcomp.github.io/website/climb-rate-computing.html"><meta property="og:type" content="article"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><style>h1,h2,h3,h4,h5,h6,.btn,[type=button],[type=submit],button,.navbar .navbar__menu li,.navbar_mobile_sidebar .navbar__menu li,.feed__author,.post__tag,.post__share>a span,.post__nav-link>span,.footer{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}body,h1,.h1,blockquote,.search__input,.author__name,.author__info>p,.feed__item h2,.post__nav-link{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://flightcomp.github.io/website/assets/css/style.css?v=cc87cb8806c844f0646558fe70d5c5d1"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://flightcomp.github.io/website/climb-rate-computing.html"},"headline":"Smartphone variometer","datePublished":"2020-04-08T22:06","dateModified":"2020-04-18T00:52","image":{"@type":"ImageObject","url":"https://flightcomp.github.io/website/media/posts/2/kalman2.png","height":534,"width":900},"description":"In this article we're going to explore the problems of computing vertical speed from pressure data obtained from meteorological or first-fix gps purpose pressure sensors, some smartphones have built-in (Bosch Sensortec BMP180, BMP280). To obtain the climb or descent rate we must take the derivative of the pressure signal with&hellip;","author":{"@type":"Person","name":"Roberto Chao"},"publisher":{"@type":"Organization","name":"Roberto Chao"}}</script><script src="https://flightcomp.github.io/website/assets/js/ls.parent-fit.min.js?v=1c78585e2a70398fe95085061942fd37"></script><script async src="https://flightcomp.github.io/website/assets/js/lazysizes.min.js?v=149ff45fc6c2f13e892e438a58abb77f"></script><script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://flightcomp.github.io/website/">Flight Computing</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><a href="https://flightcomp.github.io/website/" title="Submenu" target="_self" aria-haspopup="true">Developments</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://flightcomp.github.io/website/glide-computers.html" target="_self">Wind computing</a></li></ul></li><li class="has-submenu"><a href="https://flightcomp.github.io/website/Submenu" target="_self" aria-haspopup="true">Future researches</a><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://flightcomp.github.io/website/vario-averager.html" target="_self">TE variometer</a></li></ul></li></ul></nav><div class="search"><div class="search__overlay js-search-overlay"><div class="search__overlay-inner"><form action="https://flightcomp.github.io/website/search.html" class="search__form"><input class="search__input js-search-input" type="search" name="q" placeholder="search..." autofocus="autofocus"></form><button class="search__close js-search-close" aria-label="Close">Close</button></div></div><button class="search__btn js-search-btn" aria-label="Search"><svg role="presentation" focusable="false"><use xlink:href="https://flightcomp.github.io/website/assets/svg/svg-map.svg#search"/></svg></button></div></header><main><article class="post"><div class="hero"><figure class="hero__image"><img class="hero__image-img lazyload" data-src="https://flightcomp.github.io/website/media/posts/2/kalman2.png" data-srcset="https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-xs.png 300w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-sm.png 480w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-md.png 768w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-lg.png 1024w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-xl.png 1360w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman2-2xl.png 1600w" data-aspectratio="1.6853932584269662" data-sizes="auto" alt="" height="534" width="900"></figure><header class="hero__content"><div class="wrapper"><h1>Smartphone variometer</h1></div></header></div><div class="wrapper post__entry"><blockquote><p>In this article we're going to explore the problems of computing vertical speed from pressure data obtained from meteorological or first-fix gps purpose pressure sensors, some smartphones have built-in (Bosch Sensortec BMP180, BMP280).</p></blockquote><p>To obtain the climb or descent rate we must take the derivative of the pressure signal with respect to time and apply the equation.</p><p>$$\frac{dp}{dh}=-\frac{g}{R*T} * p \to \frac{dh}{dt} = -\frac{dp}{dt}*\frac{R*T}{g*p}$$</p><p>Derived from the hydrostatic equation and the ideal gas law, the basic physical equations used for modeling the atmosphere.</p><p>When used for free flight, the two most valuable features of a pressure sensor are frequency bandwith and precission. Newest pressure sensors improve precission in regard to oldest ones in some modes of operation because they feature an internal IIR filter that, on the other hand, reduces bandwith well below 2 Hz. For flight purposes we need at least 5 Hz of frequency bandwith and data sampling rates above 10 samples per second what makes this modes of operation unusable. Therefore we have to select a mode of operation that switches the IIR filter off raising precission to around 25 cm (0.03 hPa). If x[n] represents the noise signal added to the true pressure at the moment nT where T is de sampling period in seconds, the derivative of the pressure readings of a static sensor would be:</p><p>$$y[n]=\frac{x[n+1]-x[n]}{T}$$</p><p>Assuming uncorrelated noise, the standard deviation (RMS) of the derivative signal is:</p><p>$$\sigma_y=\frac {{\sqrt 2} \sigma_x}{T}$$</p><p>Which in the case above gives an unacceptable RMS error of 3.53 m/s in the climb/descent rate. Low pass pre-filtering of the pressure signal before making the derivative is not an option because a low-pass filter reduces bandwith and also adds delay.</p><p>Fortunately a smartphone has more sensors. One of them is a tri-axial accelerometer which detects the accelerations of the phone. We are interested in the vertical component of the acceleration after substracting gravity. We integrate this signal over time to obtain an estimation of vertical speed and integrate it once more to obtain height.</p><p>Whereas differentiation enhances high-frequency noise, integration enhances low-frequency noise, commonly known as drift. To correct for this drift we use the sensor pressure readings. This is implemented with a kalman-filter that combines both signals weighting each one in inverse proportion to its RMS.</p><p>It's relatively straightforward to obtain the typical RMS of both sensors from their datasheets or we can get this values from experimental data. Analysing data collected from the BMA220 accelerometer we can confirm that RMS noise is ten times smaller than that of the barometer BMP180 in the same smartphone. Furthermore we have detected a zero-point error of 0.1 m/s<sup>2</sup>. This states the importance of calibrating phone sensors before making any measurement. There are a lot of apps that perform this calibration proccess or you can run a calibration inside your flight app.</p><figure class="post__image post__image--center"><img class="lazyload" data-src="https://flightcomp.github.io/website/media/posts/2/magneto_dynamic.png" data-sizes="auto" data-srcset="https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-xs.png 300w ,https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-sm.png 480w ,https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-md.png 768w ,https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-lg.png 1024w ,https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-xl.png 1360w ,https://flightcomp.github.io/website/media/posts/2/responsive/magneto_dynamic-2xl.png 1600w" data-aspectratio="1.807805" width="1853" height="1025"></figure><p>The upper graph in the figure above represents the altitude output of the kalman filter (red solid line) superimposed to the data got from the barometer (black line). The lower graph represents the vertical speed output of the kalman filter superimposed to the data got from the accelerometer when we lift the phone two meters from the floor. Almost perfect!</p><p>However when we simulate strong climb/descent rates, severe inaccuracies in the accelerometer make their appareance leading to unacceptable drift in the altitude signal, and rebounds in the vertical speed signal. See the figure below.</p><figure class="post__image post__image--center"><img class="lazyload" data-src="https://flightcomp.github.io/website/media/posts/2/kalman_fails.png" data-sizes="auto" data-srcset="https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-xs.png 300w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-sm.png 480w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-md.png 768w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-lg.png 1024w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-xl.png 1360w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails-2xl.png 1600w" data-aspectratio="1.807805" width="1853" height="1025"></figure><figure class="post__image post__image--left"><img class="lazyload" data-src="https://flightcomp.github.io/website/media/posts/2/Centripetal.png" data-sizes="auto" data-srcset="https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-xs.png 300w ,https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-sm.png 480w ,https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-md.png 768w ,https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-lg.png 1024w ,https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-xl.png 1360w ,https://flightcomp.github.io/website/media/posts/2/responsive/Centripetal-2xl.png 1600w" data-aspectratio="1.134864" width="791" height="697"></figure><p>There's one more problem in trusting the accelerometer so much: The centrifugal forces generated during a turn with banking change the direction of the gravity force and sum to it making up an apparent load like when you are climbing. </p><p>Lowering the weight of the accelerometer readings over the barometer readings we  reduce drift and rebounds at the cost of increasing noise. See the figure below.</p><figure class="post__image post__image--center"><img class="lazyload" data-src="https://flightcomp.github.io/website/media/posts/2/kalman_fails2.png" data-sizes="auto" data-srcset="https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-xs.png 300w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-sm.png 480w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-md.png 768w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-lg.png 1024w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-xl.png 1360w ,https://flightcomp.github.io/website/media/posts/2/responsive/kalman_fails2-2xl.png 1600w" alt="" data-aspectratio="1.807805" width="1853" height="1025"></figure><p class="msg msg--success">The blue line corresponds to the output of our optimized algorithm. Using it we can reduce RMS noise in the vertical speed to 0.07 m/s with a fairly acceptable delay.</p></div><footer class="wrapper post__footer"><div class="post__share"></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://flightcomp.github.io/website/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://flightcomp.github.io/website/glide-computers.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Average wind computing</a></div><div class="post__nav-next"><a href="https://flightcomp.github.io/website/vario-averager.html" class="invert post__nav-link" rel="next"><span>Next</span> Vario averager </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://flightcomp.github.io/website/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2020-04-18T13:27" class="feed__date">April 18, 2020</time></div><h3 class="h1"><a href="https://flightcomp.github.io/website/total-energy-compensated-variometer.html" class="invert">Unreliability of TE variometers in horizontally wind gusts</a></h3></article></div></div></main><footer class="footer"><div class="footer__copyright"><p class="align-left">CONTACT:</p><p class="align-left">Email: <a href="mailto:theairdroid1@gmail.com">theairdroid1@gmail.com</a></p><p>© 2020 FlightComp, LLC</p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://flightcomp.github.io/website/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://flightcomp.github.io/website/assets/js/scripts.min.js?v=f56b13ba141d95ea2a0b7aab75ca9528"></script><script>var lazyFeaturedImage=function lazyFeaturedImage(){var b=document.querySelectorAll(".hero__image-img");for(var a=0;a<b.length;a++){var c=b[a];c.addEventListener("lazyloaded",function(f){var d=f.target.parentNode;d.classList.add("hero__image--overlay")})}};lazyFeaturedImage();</script></body></html>